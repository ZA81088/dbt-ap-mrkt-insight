{% macro merge_replvolumne() -%}

MERGE INTO TRANSACTION_DATA.INDUSTRY_REPL_VOLUME s
USING (
WITH DISTINCT_SEGMENT AS(
SELECT DISTINCT MATERIALID,PRICESEGMENT,PRODUCTSEGMENT
FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.MASTER_DATA.MANUAL_PRODUCT_SEGMENT    
),    
REPLGY AS (
SELECT 
    B.TIRESIZEFULL AS SIZE,
    B.RIMDIAMETERINCHES AS RIM,
    CONCAT(C.PRICESEGMENT,' ', C.PRODUCTSEGMENT) AS CarSegment,
    A.VERSION AS Version,
    A.SALESQTY AS VOLUME,
    DATE_TRUNC('YEAR', A.MONTHDATE) AS VolumeYear
FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.TRANSACTION_DATA.EDW_SALES_ACTUALS_FORECAST A
LEFT JOIN {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.MASTER_DATA.EDW_PRODUCT B
ON A.MATERIALID = B.MATERIALID
LEFT JOIN {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.MASTER_DATA.MANUAL_PRODUCT D
ON A.MATERIALID = D.MATERIALID
LEFT JOIN DISTINCT_SEGMENT C
ON A.MATERIALID = C.MATERIALID
WHERE  
A.SALESORGCODE IN ('A710')
AND A.DISTRIBUTIONCHANNELCODE IN ('11', '13', '14')  
AND D.PBUCODE = 'CON' 
AND D.BRANDNAME = 'Goodyear'
AND A.UPLOADYEAR = (SELECT MAX(UPLOADYEAR) FROM APITDBDEV.MARKETING_INSIGHT.APORA_SALES_ACTUALS_FORECAST) 
AND SUBSTR(A.VERSION, 2, 2) = (SELECT MAX(SUBSTR(VERSION, 2, 2)) FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.TRANSACTION_DATA.EDW_SALES_ACTUALS_FORECAST)
),
REPLGYSUM AS (
SELECT 
    SUM(VOLUME) AS VOLUME,
    SIZE,
    RIM,
    CarSegment,
    Version,
    VolumeYear
FROM REPLGY
GROUP BY
    SIZE,
    RIM,
    CarSegment,
    Version,
    VolumeYear
)
SELECT * FROM REPLGYSUM) d
ON s.TIRESIZE = d.SIZE AND s.RIMSIZE = d.RIM AND s.CarSegment = d.CarSegment AND s.MeasureYear = d.VolumeYear
WHEN MATCHED THEN UPDATE SET
    s.GYVOLUME = d.VOLUME,
    s.Version = d.Version
WHEN NOT MATCHED THEN
    INSERT (
        COUNTRY,
        REGION,
        TIRESIZE,
        RIMSIZE,
        CarSegment,
        Version,
	    REPLMARKET,
        GYVOLUME,
        MeasureYear
    )
    VALUES(
        'Mainland China',
        'Greater China',
        d.SIZE,
        d.RIM,
        d.CarSegment,
        d.Version,
        0,
        d.VOLUME,
        d.VOLUMEYEAR    
    );

MERGE INTO TRANSACTION_DATA.INDUSTRY_REPL_VOLUME s
USING (
WITH DISTINCT_SEGMENT AS(
SELECT DISTINCT MATERIALID,PRICESEGMENT,PRODUCTSEGMENT
FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.MASTER_DATA.MANUAL_PRODUCT_SEGMENT    
),    
REPLCP AS (
SELECT 
    B.TIRESIZEFULL AS SIZE,
    B.RIMDIAMETERINCHES AS RIM,
    CONCAT(C.PRICESEGMENT,' ', C.PRODUCTSEGMENT) AS CarSegment,
    A.VERSION,
    A.SALESQTY AS VOLUME,
    DATE_TRUNC('YEAR', A.MONTHDATE) AS VolumeYear
FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.TRANSACTION_DATA.EDW_SALES_ACTUALS_FORECAST A
LEFT JOIN {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.MASTER_DATA.EDW_PRODUCT B
ON A.MATERIALID = B.MATERIALID
INNER JOIN {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.MASTER_DATA.MANUAL_PRODUCT D
ON A.MATERIALID = D.MATERIALID  
INNER JOIN DISTINCT_SEGMENT C
ON A.MATERIALID = C.MATERIALID
WHERE  
A.SALESORGCODE IN ('A710')
AND A.DISTRIBUTIONCHANNELCODE IN ('11', '13', '14')
AND B.PBUCODE = 'CON'
AND D.BRANDNAME = 'Cooper'
AND A.UPLOADYEAR = (SELECT MAX(UPLOADYEAR) FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.TRANSACTION_DATA.EDW_SALES_ACTUALS_FORECAST) 
AND SUBSTR(A.VERSION, 2, 2) = (SELECT MAX(SUBSTR(VERSION, 2, 2)) FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.TRANSACTION_DATA.EDW_SALES_ACTUALS_FORECAST)
),
REPLCPSUM AS (
SELECT 
    SUM(VOLUME) AS VOLUME,
    SIZE,
    RIM,
    CarSegment,
    Version,
    VolumeYear
FROM REPLCP
GROUP BY
    SIZE,
    RIM,
    CarSegment,
    Version,
    VolumeYear
)
SELECT * FROM REPLCPSUM) d
ON s.TIRESIZE = d.SIZE AND s.RIMSIZE = d.RIM AND s.CarSegment = d.CarSegment AND s.MeasureYear = d.VolumeYear
WHEN MATCHED THEN UPDATE SET
    s.CPVOLUME = d.VOLUME,
    s.Version = d.Version
WHEN NOT MATCHED THEN
    INSERT (
        COUNTRY,
        REGION,
        TIRESIZE,
        RIMSIZE,
        CarSegment,
        Version,
	    REPLMARKET,
        CPVOLUME,
        MeasureYear
    )
    VALUES(
        'Mainland China',
        'Greater China',
        d.SIZE,
        d.RIM,
        d.CarSegment,
        d.Version,
        0,
        d.VOLUME,
        d.VOLUMEYEAR    
    );

{%- endmacro %}