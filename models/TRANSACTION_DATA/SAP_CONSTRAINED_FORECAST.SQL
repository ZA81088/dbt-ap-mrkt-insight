{{ 
    config (materialized = 'incremental', schema = 'TRANSACTION_DATA', 
    unique_key = ['SALESORGCODE', 'DISTRIBUTIONCHANNELCODE', 'CUSTOMERID', 'MATERIALID', 'VERSION', 'VERSIONLAG', 
    'UPLOADYEAR', 'CALENDARYEARMONTH'], pre_hook = "delete FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.TRANSACTION_DATA.
    SAP_CONSTRAINED_FORECAST WHERE (VERSION, UPLOADYEAR) IN (SELECT VERSION, UPLOADYEAR FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.STAGING.SAP_CONSTRAINED_FORECAST);"
    
    )
}}

SELECT CONSTRAINFORECAST,SALESORGCODE, DISTRIBUTIONCHANNELCODE, CUSTOMERID, MATERIALID, VERSION, VERSIONLAG, UPLOADYEAR, 
CALENDARYEARMONTH, LASTMODIFIEDTIME FROM {{ env_var('DBT_SOURCE_DATABASE', 'APITDBDEV') }}.STAGING.SAP_CONSTRAINED_FORECAST

{% if is_incremental() %}

  -- this filter will only be applied on an incremental run
  where LASTMODIFIEDTIME > (select max(LASTMODIFIEDTIME) from {{ this }})

{% endif %}