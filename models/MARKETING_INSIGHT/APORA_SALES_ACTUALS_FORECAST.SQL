{{ 
    config ( materialized='table' , schema='MARKETING_INSIGHT' )
}}

--SELECT * FROM APITDBDEV.MARKETING_INSIGHT.APORA_SALES_ACTUALS_FORECAST WHERE SUBSTR(VERSION,2,2) < MONTH(CURRENT_DATE())-1

--UNION ALL

SELECT SF.MATERIALID, 
        SF.SALESORGCODE, 
        SF.DISTRIBUTIONCHANNELCODE AS DISTRIBUTIONCHANNELCODE, 
        SF.CONSTRAINFORECAST AS SALESQTY, 
        SF.Version,
        SF.UPLOADYEAR,
        SF.CALENDARYEARMONTH AS MONTHDATE
FROM 
        APITDBDEV.STAGING.MANUAL_CONSTRAINED_FORECAST SF
        

WHERE (MONTHDATE >= date_trunc('month', current_date()) AND 
       UPLOADYEAR = YEAR(CURRENT_DATE()) AND 
       SUBSTR(SF.VERSION,2,2) = MONTH(CURRENT_DATE())-1)

UNION ALL

SELECT SA.MATERIALID, 
        SA.SALESORGCODE, 
        SA.DISTRIBUTIONCHANNELCODE, 
        SA.SALESQTY AS SALESQTY, 
        CASE 
        WHEN MONTH(CURRENT_DATE()) = 1 THEN 'V00+12' 
        WHEN MONTH(CURRENT_DATE()) = 2 THEN 'V01+11'
        WHEN MONTH(CURRENT_DATE()) = 3 THEN 'V02+10'
        WHEN MONTH(CURRENT_DATE()) = 4 THEN 'V03+09'
        WHEN MONTH(CURRENT_DATE()) = 5 THEN 'V04+08'
        WHEN MONTH(CURRENT_DATE()) = 6 THEN 'V05+07'
        WHEN MONTH(CURRENT_DATE()) = 7 THEN 'V06+06'
        WHEN MONTH(CURRENT_DATE()) = 8 THEN 'V07+05'
        WHEN MONTH(CURRENT_DATE()) = 9 THEN 'V08+04'
        WHEN MONTH(CURRENT_DATE()) = 10 THEN 'V09+03'
        WHEN MONTH(CURRENT_DATE()) = 11 THEN 'V10+02'
        WHEN MONTH(CURRENT_DATE()) = 12 THEN 'V11+01'
        END AS Version,
        YEAR(CURRENT_DATE()) AS UPLOADYEAR,
        SA.MONTHDATE
FROM 
        APITDBDEV.STAGING.EDW_TRANSACTIONAL_SALESACTUAL SA
      

WHERE Monthdate < date_trunc('month', current_date())